{% extends 'base.html' %}
{% block title %}Registrar Avaria{% endblock %}
{% block content %}
<form method="post" enctype="multipart/form-data" class="report-form" id="avariaForm">
    <section class="card">
        <header class="section-header">
            <h2>Registro de avaria</h2>
            <p>Documente avarias encontradas nos veículos com fotos e descrição detalhada</p>
        </header>
        <div class="form-grid">
            <label>
                <span>Veículo <strong style="color: #dc2626;">*</strong></span>
                <select name="veiculo_id" required>
                    <option value="">Selecione o veículo...</option>
                    {% for veiculo in veiculos %}
                        <option value="{{ veiculo.id }}">{{ veiculo.modelo }} · {{ veiculo.placa }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                <span>Data e horário da constatação <strong style="color: #dc2626;">*</strong></span>
                <input type="datetime-local" name="data_hora_avaria" id="dataHoraAvaria" required>
            </label>
        </div>
    </section>

    <section class="card">
        <header class="section-header">
            <h2>Avarias com registro fotográfico</h2>
            <p>Preencha pelo menos uma avaria com descrição e foto</p>
        </header>
        <div id="avariaList" class="avaria-list">
            <div class="avaria-item">
                <label>
                    <span>Descrição <strong style="color: #dc2626;">*</strong></span>
                    <input type="text" name="avaria_descricao[]" placeholder="Ex: Risco lateral esquerda" required>
                </label>
                <label>
                    <span>Localização</span>
                    <input type="text" name="avaria_local[]" placeholder="Painel, porta, etc.">
                </label>
                <label>
                    <span>Foto (câmera) <strong style="color: #dc2626;">*</strong></span>
                    <input type="file" name="avaria_foto[]" accept="image/*" capture="environment" required>
                </label>
            </div>
        </div>
        <button type="button" class="btn btn-ghost" id="btnAddAvaria">+ Adicionar outra avaria</button>
    </section>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-large">Registrar avaria(s)</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

<script>
// Define data e hora atual no campo datetime-local
document.addEventListener('DOMContentLoaded', () => {
    const dataHoraInput = document.getElementById('dataHoraAvaria');
    const now = new Date();
    // Formata para YYYY-MM-DDTHH:MM (formato datetime-local)
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    dataHoraInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
});

// Adiciona novas avarias
document.getElementById('btnAddAvaria').addEventListener('click', () => {
    const container = document.getElementById('avariaList');
    const newItem = document.createElement('div');
    newItem.className = 'avaria-item';
    newItem.innerHTML = `
        <label>
            <span>Descrição <strong style="color: #dc2626;">*</strong></span>
            <input type="text" name="avaria_descricao[]" placeholder="Ex: Risco lateral esquerda" required>
        </label>
        <label>
            <span>Localização</span>
            <input type="text" name="avaria_local[]" placeholder="Painel, porta, etc.">
        </label>
        <label>
            <span>Foto (câmera) <strong style="color: #dc2626;">*</strong></span>
            <input type="file" name="avaria_foto[]" accept="image/*" capture="environment" required>
        </label>
        <button type="button" class="btn btn-ghost btn-remove-avaria" onclick="this.parentElement.remove()">× Remover</button>
    `;
    container.appendChild(newItem);
});
</script>
{% endblock %}
