{% extends 'base.html' %}
{% block title %}Histórico de Relatórios{% endblock %}
{% block content %}
<section class="card">
    <header class="section-header">
        <h2>Histórico de relatórios</h2>
        <button id="print-pdf" class="icon-button no-print" type="button" aria-label="Imprimir PDF">
            <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 9V2h12v7" />
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
                <path d="M6 14h12v8H6z" />
            </svg>
            <span>Imprimir</span>
        </button>
    </header>
    <style>
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.45rem 0.75rem;
            border: 1px solid #d0d7de;
            background: #f7f9fb;
            color: #0f172a;
            border-radius: 6px;
            cursor: pointer;
        }
        .icon-button:hover { background: #e8edf2; }
        .percurso-col { font-weight: 600; }
        /* Links com aspecto do histórico de abastecimentos */
        a.link-accent { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        a.link-accent:hover { text-decoration: underline; }
        /* Cabeçalhos responsivos para evitar quebras em telas estreitas */
        table thead th { font-size: clamp(0.75rem, 2.4vw, 0.9rem); white-space: nowrap; letter-spacing: 0.04em; }
        /* Ícone no cabeçalho 'Detalhes' para telas pequenas */
        .details-col .label { display: inline; }
        .details-col .icon { display: none; vertical-align: -2px; }
        /* Troca 'Percurso' por 'km' em telas pequenas */
        .percurso-col .label { display: inline; }
        .percurso-col .short { display: none; }
        /* Colunas compactas com overflow controlado */
        th.percurso-col, td.percurso-col { white-space: nowrap; text-align: center; }
        th.details-col, td.details-col { white-space: nowrap; text-align: center; }
        td.percurso-col, td.details-col { overflow: hidden; text-overflow: clip; }
        /* Toggle de datas: formato curto em telas pequenas */
        .date-full { display: inline; }
        .date-short { display: none; }
        @media (max-width: 550px) {
            .details-col .label { display: none; }
            .details-col .icon { display: inline; }
            .percurso-col .label { display: none; }
            .percurso-col .short { display: inline; }
            /* Larguras mínimas para evitar sobreposição */
            th.percurso-col, td.percurso-col { width: 64px; max-width: 72px; }
            th.details-col, td.details-col { width: 52px; max-width: 60px; }
            td.details-col a { display: inline-block; }
            /* Formato curto de data */
            .date-full { display: none; }
            .date-short { display: inline; }
        }
        .no-print { display: inline-flex; }
        @media print {
            body, .card, .table-wrapper, table, th, td { background: #fff !important; color: #000 !important; }
            .no-print, nav, header.site-header { display: none !important; }
            .details-col { display: none !important; }
            .percurso-col { display: table-cell !important; }
            .section-header { display: block; }
        }
    </style>
    {% macro format_date(date_str) %}
        {%- if date_str -%}
            {%- set parts = date_str.split('-') -%}
            {%- if parts|length == 3 -%}
                {{ parts[2] ~ '/' ~ parts[1] ~ '/' ~ parts[0] }}
            {%- else -%}
                {{ date_str }}
            {%- endif -%}
        {%- else -%}
            -
        {%- endif -%}
    {% endmacro %}
    {% macro format_date_short(date_str) %}
        {%- if date_str -%}
            {%- set parts = date_str.split('-') -%}
            {%- if parts|length == 3 -%}
                {{ parts[2] ~ '/' ~ parts[1] ~ '/' ~ parts[0][2:] }}
            {%- else -%}
                {{ date_str }}
            {%- endif -%}
        {%- else -%}
            -
        {%- endif -%}
    {% endmacro %}
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Veículo</th>
                    <th>Saída</th>
                    <th>Entrega</th>
                    <th class="percurso-col"><span class="label">Percurso</span><span class="short">km</span></th>
                    <th class="details-col">
                        <span class="label">Detalhes</span>
                        <svg class="icon" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="M21 21l-4.3-4.3"></path>
                        </svg>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for item in relatorios|sort(attribute='partida_at', reverse=True) %}
                    {% set partida = item.relatorio_partida or item.relatorio or {} %}
                    {% set entrega = item.relatorio_entrega or {} %}
                    {% set cab_partida = partida.cabecalho or {} %}
                    {% set cab_entrega = entrega.cabecalho or {} %}
                    {% set veiculo = item.veiculo or {} %}
                    {% set km_inicial = (cab_partida.km_inicial or 0)|int %}
                    {% set km_final = (cab_entrega.km_final or 0)|int %}
                    {% set percurso = km_final - km_inicial if cab_entrega and cab_entrega.km_final is not none and cab_partida.km_inicial is not none else None %}
                    <tr>
                        <td>
                            <div>{{ (veiculo.modelo ~ ' · ' ~ veiculo.placa) if veiculo else (cab_partida.modelo ~ ' · ' ~ cab_partida.placa) }}</div>
                            {% if item.nome %}
                                <div style="font-size: 0.9em; color: #666;">{{ item.nome }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if cab_partida.data_saida or cab_partida.hora_saida %}
                                <div>
                                    <span class="date-full">{{ format_date(cab_partida.data_saida) }}</span>
                                    <span class="date-short">{{ format_date_short(cab_partida.data_saida) }}</span>
                                </div>
                                <div style="font-size: 0.9em; color: #666;">{{ cab_partida.hora_saida or '-' }}</div>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if cab_entrega %}
                                <div>
                                    <span class="date-full">{{ format_date(cab_entrega.data_chegada) }}</span>
                                    <span class="date-short">{{ format_date_short(cab_entrega.data_chegada) }}</span>
                                </div>
                                <div style="font-size: 0.9em; color: #666;">{{ cab_entrega.hora_chegada or '-' }}</div>
                            {% else %}
                                {% if item.viagem_aberta %}
                                    Em aberto
                                {% else %}
                                    -
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="percurso-col">
                            {% if percurso is not none %}
                                {{ percurso }} km
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="details-col"><a class="link-accent" href="{{ url_for('relatorio_detalhe', relatorio_id=item.id) }}">Ver</a></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
<script>
    document.getElementById('print-pdf')?.addEventListener('click', () => {
        window.print();
    });
</script>
{% endblock %}
