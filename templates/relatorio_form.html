{% extends 'base.html' %}
{% block title %}Novo Relatório{% endblock %}
{% block content %}
<form method="post" enctype="multipart/form-data" class="report-form">
    <section class="card">
        <header class="section-header">
            <h2>Checklist de partida</h2>
            <p>Preencha todos os campos antes de deixar a base. A entrega será registrada em outro passo.</p>
        </header>
        <div class="form-grid">
            <label>
                <span>Veículo cadastrado</span>
                <select name="veiculo_id" id="veiculoSelect" required>
                    <option value="">Selecione...</option>
                    {% for veiculo in veiculos %}
                        <option value="{{ veiculo.id }}"
                            data-modelo="{{ veiculo.modelo }}"
                            data-placa="{{ veiculo.placa }}"
                            data-marca="{{ veiculo.marca }}"
                            data-tipo="{{ veiculo.tipo }}"
                            {% if veiculo.circulando %}disabled{% endif %}>
                            {{ veiculo.modelo }} · {{ veiculo.placa }}{% if veiculo.circulando %} (em uso){% endif %}
                        </option>
                    {% endfor %}
                </select>
                <input type="hidden" name="modelo" id="fieldModelo">
                <input type="hidden" name="placa" id="fieldPlaca">
                <input type="hidden" name="marca" id="fieldMarca">
                <input type="hidden" name="tipo" id="fieldTipo">
            </label>
            <label>
                <span>Data e horário da saída</span>
                <input type="datetime-local" name="data_hora_saida" required>
            </label>
            <label>
                <span>KM inicial</span>
                <input type="number" name="km_inicial" step="1" required>
            </label>
        </div>
        <label class="full-row">
            <span>Trajeto / breve relato do itinerário</span>
            <textarea name="trajeto" rows="3" placeholder="Descreva o trajeto realizado"></textarea>
        </label>
    </section>

    <section class="card">
        <header class="section-header">
            <div>
                <h2>Riscos ou avarias do veículo</h2>
            </div>
            <div class="legend">
                <span>C = conforme</span>
                <span>NC = não conforme</span>
                <span>X = não aplicável</span>
            </div>
        </header>
        <div class="component-table risco-table">
            {% for risco in risco_pontos %}
                <div class="component-row" data-status-row>
                    <div class="component-header">
                        <div class="component-name">{{ risco.label }}</div>
                        <select name="risco_status_{{ risco.id }}" class="status-select" data-status-select>
                            <option value="C">C</option>
                            <option value="NC">NC</option>
                            <option value="X">X</option>
                        </select>
                    </div>
                    <div class="risco-obs" data-status-obs hidden>
                        <textarea name="risco_obs_{{ risco.id }}" rows="2" placeholder="Observações"></textarea>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="fuel-gauges">
            {% set fuel_max_index = fuel_levels|length - 1 %}
            {% set default_saida_index = fuel_max_index %}
            <label class="full-row">
                <span>Nível na saída</span>
                <div class="fuel-slider" data-fuel-control>
                    <input type="hidden" name="combustivel_saida" value="cheio" data-fuel-value>
                    <input type="range"
                           min="0"
                           max="{{ fuel_max_index }}"
                           step="1"
                           value="{{ default_saida_index }}"
                           data-fuel-slider
                           aria-label="Nível de combustível na saída">
                    <div class="fuel-scale">
                        {% for level in fuel_levels %}
                            <span data-fuel-label data-value="{{ level }}">{{ level }}</span>
                        {% endfor %}
                    </div>
                </div>
            </label>
        </div>
    </section>

    <section class="card">
        <header class="section-header">
            <h2>Componentes / avarias</h2>
            <p>Checklist antes da utilização</p>
        </header>
        <div class="component-table">
            {% for comp in componentes %}
                <div class="component-row" data-status-row>
                    <div class="component-header">
                        <div class="component-name">{{ comp.label }}</div>
                        <select name="component_status_{{ comp.id }}" class="status-select" data-status-select>
                            <option value="C">C</option>
                            <option value="NC">NC</option>
                            <option value="X">X</option>
                        </select>
                    </div>
                    <div class="component-obs" data-status-obs hidden>
                        <input type="text" name="component_obs_{{ comp.id }}" placeholder="Descreva o motivo">
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-large">Iniciar viagem</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>
{% endblock %}
